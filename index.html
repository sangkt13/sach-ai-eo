<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IELTS Vocabulary Book Study + Writing Corrector (PDF + ChatGPT)</title>

  <!-- UI (no build tools) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js"></script>

  <style>
    /* PDF canvas crisp */
    canvas { image-rendering: -webkit-optimize-contrast; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex flex-col">

    <!-- Top bar -->
    <header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b">
      <div class="max-w-[1400px] mx-auto px-4 py-3 flex items-center gap-3">
        <div class="flex items-center gap-2">
          <div class="w-9 h-9 rounded-xl bg-slate-900 text-white grid place-items-center font-bold">I</div>
          <div>
            <div class="font-semibold leading-tight">IELTS Book Study + Writing Corrector</div>
            <div class="text-xs text-slate-500 leading-tight">M·ªü PDF s√°ch, h·ªçc theo Unit, l∆∞u ti·∫øn ƒë·ªô, ch·∫•m/s·ª≠a Writing b·∫±ng ChatGPT</div>
          </div>
        </div>

        <div class="ml-auto flex items-center gap-2">
          <label class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 cursor-pointer text-sm">
            <input id="pdfFile" type="file" accept="application/pdf" class="hidden" />
            üìÑ Ch·ªçn PDF
          </label>

          <button id="btnSave" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm">
            üíæ L∆∞u
          </button>

          <button id="btnReset" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">
            ‚ôªÔ∏è Reset
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1">
      <div class="max-w-[1400px] mx-auto px-4 py-4 grid grid-cols-12 gap-4">

        <!-- Sidebar: Units / Progress -->
        <aside class="col-span-12 lg:col-span-3">
          <div class="bg-white rounded-2xl border shadow-sm p-4">
            <div class="flex items-center justify-between">
              <h2 class="font-semibold">L·ªô tr√¨nh theo Unit</h2>
              <span id="progressText" class="text-xs text-slate-500"></span>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="btnTOCDefault" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-xs">
                D√πng m·ª•c l·ª•c m·∫´u
              </button>
              <button id="btnTOCEdit" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-xs">
                S·ª≠a map trang
              </button>
            </div>

            <div id="tocEditBox" class="hidden mt-3">
              <div class="text-xs text-slate-600 mb-2">
                B·∫°n c√≥ th·ªÉ ch·ªânh ‚ÄúPDF page‚Äù cho ƒë√∫ng v·ªõi file c·ªßa b·∫°n (ƒë·∫∑c bi·ªát n·∫øu PDF l√† b·∫£n tr√≠ch). M·ªói d√≤ng: <span class="mono">unitId|pdfPage</span>
              </div>
              <textarea id="tocEditor" class="w-full h-40 p-2 border rounded-xl text-xs mono"></textarea>
              <div class="mt-2 flex gap-2">
                <button id="btnApplyTOC" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-xs">
                  √Åp d·ª•ng
                </button>
                <button id="btnCancelTOC" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-xs">
                  H·ªßy
                </button>
              </div>
            </div>

            <div class="mt-4">
              <input id="unitSearch" class="w-full px-3 py-2 border rounded-xl text-sm" placeholder="T√¨m Unit (vd: growing, business, writing)..." />
            </div>

            <div id="unitList" class="mt-3 space-y-2 max-h-[62vh] overflow-auto pr-1"></div>
          </div>

          <div class="bg-white rounded-2xl border shadow-sm p-4 mt-4">
            <h3 class="font-semibold">Ghi ch√∫ nhanh</h3>
            <textarea id="quickNotes" class="mt-2 w-full h-32 p-3 border rounded-xl text-sm" placeholder="Ghi ch√∫ t·ª´ v·ª±ng/collocation b·∫°n mu·ªën nh·ªõ..."></textarea>
            <div class="mt-2 text-xs text-slate-500">
              Ghi ch√∫ ƒë∆∞·ª£c l∆∞u tr√™n tr√¨nh duy·ªát (localStorage).
            </div>
          </div>
        </aside>

        <!-- PDF Viewer -->
        <section class="col-span-12 lg:col-span-6">
          <div class="bg-white rounded-2xl border shadow-sm">
            <div class="p-4 border-b flex items-center gap-2">
              <div class="font-semibold">PDF Viewer</div>
              <div class="ml-auto flex items-center gap-2">
                <button id="btnPrev" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">‚óÄ</button>
                <div class="text-sm">
                  Trang <span id="pageNum">-</span>/<span id="pageCount">-</span>
                </div>
                <button id="btnNext" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">‚ñ∂</button>

                <div class="w-px h-7 bg-slate-200 mx-1"></div>

                <button id="btnZoomOut" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">‚àí</button>
                <button id="btnZoomIn" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">Ôºã</button>
              </div>
            </div>

            <div class="p-4">
              <div id="pdfHint" class="p-4 rounded-xl bg-slate-50 border text-sm text-slate-700">
                1) B·∫•m <b>Ch·ªçn PDF</b> ƒë·ªÉ m·ªü s√°ch tr√™n m√°y b·∫°n. <br/>
                2) Ch·ªçn Unit ·ªü c·ªôt tr√°i ƒë·ªÉ nh·∫£y ƒë·∫øn trang t∆∞∆°ng ·ª©ng. <br/>
                3) L√†m Writing ·ªü c·ªôt ph·∫£i v√† b·∫•m <b>Ch·∫•m/S·ª≠a</b>.
              </div>

              <div id="pdfWrap" class="hidden">
                <div class="w-full overflow-auto rounded-xl border bg-slate-100">
                  <canvas id="pdfCanvas" class="block mx-auto"></canvas>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-2xl border shadow-sm p-4 mt-4">
            <h3 class="font-semibold">Checklist h·ªçc m·ªói Unit (g·ª£i √Ω)</h3>
            <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              <label class="flex items-start gap-2"><input type="checkbox" class="mt-1" data-check="skim" /> Skim b√†i + g·∫°ch t·ª´ m·ªõi</label>
              <label class="flex items-start gap-2"><input type="checkbox" class="mt-1" data-check="collocations" /> Ghi collocations/word families</label>
              <label class="flex items-start gap-2"><input type="checkbox" class="mt-1" data-check="practice" /> L√†m b√†i t·∫≠p trong Unit</label>
              <label class="flex items-start gap-2"><input type="checkbox" class="mt-1" data-check="review" /> √în l·∫°i b·∫±ng c√¢u v√≠ d·ª• (5‚Äì10 c√¢u)</label>
            </div>
            <div class="mt-2 text-xs text-slate-500">
              Checklist n√†y l∆∞u theo tr√¨nh duy·ªát, kh√¥ng li√™n quan n·ªôi dung b·∫£n quy·ªÅn trong s√°ch.
            </div>
          </div>
        </section>

        <!-- Writing Corrector -->
        <aside class="col-span-12 lg:col-span-3">
          <div class="bg-white rounded-2xl border shadow-sm p-4">
            <h2 class="font-semibold">Writing Corrector (ChatGPT)</h2>

            <div class="mt-2 p-3 rounded-xl bg-amber-50 border text-xs text-amber-900">
              ‚ö†Ô∏è <b>Khuy·∫øn ngh·ªã</b>: D√πng ‚ÄúProxy mode‚Äù (server) ƒë·ªÉ gi·ªØ an to√†n API key. OpenAI khuy·∫øn c√°o kh√¥ng ƒë·ªÉ key trong client. :contentReference[oaicite:2]{index=2}
            </div>

            <div class="mt-3">
              <label class="text-xs text-slate-600">Ch·∫ø ƒë·ªô g·ªçi API</label>
              <div class="mt-1 flex gap-2">
                <button id="modeClient" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-xs">Client mode (nhanh)</button>
                <button id="modeProxy" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-xs">Proxy mode (an to√†n)</button>
              </div>
              <div id="modeHint" class="mt-2 text-xs text-slate-500"></div>
            </div>

            <div class="mt-3">
              <label class="text-xs text-slate-600">API key (ch·ªâ l∆∞u local)</label>
              <input id="apiKey" type="password" class="mt-1 w-full px-3 py-2 border rounded-xl text-sm" placeholder="sk-..." />
            </div>

            <div class="mt-3">
              <label class="text-xs text-slate-600">Proxy URL (n·∫øu d√πng Proxy mode)</label>
              <input id="proxyUrl" class="mt-1 w-full px-3 py-2 border rounded-xl text-sm" placeholder="V√≠ d·ª•: /api/openai" />
              <div class="mt-1 text-xs text-slate-500">
                Proxy s·∫Ω nh·∫≠n JSON v√† forward t·ªõi OpenAI. (M√¨nh ƒë·ªÉ m·∫´u code proxy ·ªü cu·ªëi file n√†y.)
              </div>
            </div>

            <div class="mt-3">
              <label class="text-xs text-slate-600">Lo·∫°i b√†i</label>
              <select id="taskType" class="mt-1 w-full px-3 py-2 border rounded-xl text-sm">
                <option value="ielts_task1_academic">IELTS Academic Task 1</option>
                <option value="ielts_task2_academic" selected>IELTS Academic Task 2</option>
                <option value="ielts_gt_task1">General Training Task 1</option>
                <option value="ielts_gt_task2">General Training Task 2</option>
              </select>
            </div>

            <div class="mt-3">
              <label class="text-xs text-slate-600">ƒê·ªÅ b√†i (prompt)</label>
              <textarea id="writingPrompt" class="mt-1 w-full h-24 p-3 border rounded-xl text-sm" placeholder="D√°n ƒë·ªÅ IELTS v√†o ƒë√¢y..."></textarea>
            </div>

            <div class="mt-3">
              <label class="text-xs text-slate-600">B√†i b·∫°n vi·∫øt</label>
              <textarea id="writingDraft" class="mt-1 w-full h-40 p-3 border rounded-xl text-sm" placeholder="D√°n b√†i vi·∫øt c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="btnCheck" class="flex-1 px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm">
                ‚úÖ Ch·∫•m / S·ª≠a
              </button>
              <button id="btnClearWriting" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm">
                X√≥a
              </button>
            </div>

            <div class="mt-3">
              <label class="text-xs text-slate-600">K·∫øt qu·∫£</label>
              <div id="resultBox" class="mt-1 w-full min-h-40 p-3 border rounded-xl text-sm bg-slate-50 whitespace-pre-wrap"></div>
            </div>
          </div>

          <div class="bg-white rounded-2xl border shadow-sm p-4 mt-4">
            <h3 class="font-semibold">T·ª´ v·ª±ng theo Unit ƒëang h·ªçc</h3>
            <div class="mt-2 text-xs text-slate-500">
              Khi b·∫°n ch·ªçn Unit ·ªü c·ªôt tr√°i, app s·∫Ω d√πng t√™n ch·ªß ƒë·ªÅ Unit ƒë·ªÉ g·ª£i √Ω ch·∫•m b√†i ‚Äú∆∞u ti√™n vocabulary theo ch·ªß ƒë·ªÅ‚Äù.
            </div>
            <div id="activeUnitBox" class="mt-3 p-3 rounded-xl border bg-white">
              <div class="text-sm font-medium" id="activeUnitTitle">Ch∆∞a ch·ªçn Unit</div>
              <div class="text-xs text-slate-500" id="activeUnitTopics">‚Äî</div>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <footer class="border-t bg-white">
      <div class="max-w-[1400px] mx-auto px-4 py-4 text-xs text-slate-500">
        App h·ªçc s√°ch d·ª±a tr√™n vi·ªác b·∫°n t·ª± m·ªü PDF. Kh√¥ng sao ch√©p n·ªôi dung s√°ch ra ngo√†i.
      </div>
    </footer>
  </div>

<script>
/* =========================
   Storage helpers
========================= */
const LS_KEY = "ielts_book_study_v1";
function loadState() {
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }
  catch { return {}; }
}
function saveState(partial) {
  const cur = loadState();
  const next = { ...cur, ...partial };
  localStorage.setItem(LS_KEY, JSON.stringify(next));
  return next;
}
function resetState() {
  localStorage.removeItem(LS_KEY);
  location.reload();
}

/* =========================
   Default TOC (based on the provided PDF excerpt)
   - You can edit these later in UI.
   - pdfPage is 1-based.
========================= */
const DEFAULT_UNITS = [
  // Main Units (from Contents/Map of the book pages)
  { id:"u1",  title:"Unit 1 ‚Äî Growing up", topics:"Relationships, families and early learning", pdfPage:11 },
  { id:"u2",  title:"Unit 2 ‚Äî Mental and physical development", topics:"The body, the mind", pdfPage:15 },
  { id:"u3",  title:"Unit 3 ‚Äî Keeping fit", topics:"Diet, health and exercise", pdfPage:19 },

  // The full book has more units (4‚Äì20) + language building + writing units.
  // If your PDF includes them, just map their starting pages in TOC editor.
  { id:"u4",  title:"Unit 4 ‚Äî Lifestyles", topics:"Life, leisure", pdfPage:0 },
  { id:"u5",  title:"Unit 5 ‚Äî Student life", topics:"Study, education, research", pdfPage:0 },
  { id:"u6",  title:"Unit 6 ‚Äî Effective communication", topics:"Language, linguistics", pdfPage:0 },
  { id:"u7",  title:"Unit 7 ‚Äî On the move", topics:"Tourism, travel", pdfPage:0 },
  { id:"u8",  title:"Unit 8 ‚Äî Through the ages", topics:"Time, history", pdfPage:0 },
  { id:"u9",  title:"Unit 9 ‚Äî The natural world", topics:"Flora and fauna, agriculture", pdfPage:0 },
  { id:"u10", title:"Unit 10 ‚Äî Reaching for the skies", topics:"Space, the planets", pdfPage:0 },
  { id:"u11", title:"Unit 11 ‚Äî Design and innovation", topics:"Building, engineering", pdfPage:0 },
  { id:"u12", title:"Unit 12 ‚Äî Information technology", topics:"Telecommunications, computers and technology", pdfPage:0 },
  { id:"u13", title:"Unit 13 ‚Äî The modern world", topics:"Globalisation, changing attitudes and trends", pdfPage:0 },
  { id:"u14", title:"Unit 14 ‚Äî Urbanisation", topics:"Problems and solutions, big city life", pdfPage:0 },
  { id:"u15", title:"Unit 15 ‚Äî The green revolution", topics:"The environment, climate change and pollution", pdfPage:0 },
  { id:"u16", title:"Unit 16 ‚Äî The energy crisis", topics:"Natural resources, alternative fuels", pdfPage:0 },
  { id:"u17", title:"Unit 17 ‚Äî Talking business", topics:"Employment, management and marketing", pdfPage:0 },
  { id:"u18", title:"Unit 18 ‚Äî The law", topics:"Crime, punishment", pdfPage:0 },
  { id:"u19", title:"Unit 19 ‚Äî The media", topics:"The news, fame", pdfPage:0 },
  { id:"u20", title:"Unit 20 ‚Äî The arts", topics:"Art appreciation, the performing arts", pdfPage:0 },

  // Reference / writing practice (map if your PDF includes)
  { id:"u21", title:"Unit 21 ‚Äî Language building 1", topics:"Using a dictionary, word families", pdfPage:0 },
  { id:"u22", title:"Unit 22 ‚Äî Language building 2", topics:"Learning vocabulary, collocation", pdfPage:0 },
  { id:"u23", title:"Unit 23 ‚Äî Academic Writing Task 1", topics:"Data, graphs and tables, diagrams and processes", pdfPage:0 },
  { id:"u24", title:"Unit 24 ‚Äî Academic Writing Task 2", topics:"Linking words, opinion words, register", pdfPage:0 },
  { id:"u25", title:"Unit 25 ‚Äî General Training Writing", topics:"Vocabulary for Writing Tasks 1 and 2", pdfPage:0 },
];

function unitsFromState() {
  const st = loadState();
  return st.units || DEFAULT_UNITS;
}

/* =========================
   PDF.js viewer
========================= */
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js";

let pdfDoc = null;
let currentPage = 1;
let scale = 1.2;

const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");

async function renderPage(pageNum) {
  if (!pdfDoc) return;

  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale });

  canvas.width = Math.floor(viewport.width);
  canvas.height = Math.floor(viewport.height);

  const renderContext = { canvasContext: ctx, viewport };
  await page.render(renderContext).promise;

  currentPage = pageNum;
  document.getElementById("pageNum").textContent = currentPage;
  document.getElementById("pageCount").textContent = pdfDoc.numPages;
}

async function openPdfFromArrayBuffer(buf) {
  pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;
  document.getElementById("pdfHint").classList.add("hidden");
  document.getElementById("pdfWrap").classList.remove("hidden");
  currentPage = 1;
  await renderPage(currentPage);
}

function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

/* =========================
   UI: Unit list + progress
========================= */
let activeUnitId = null;

function getProgress() {
  const st = loadState();
  const done = st.doneUnits || {};
  const units = unitsFromState().filter(u => u.id.startsWith("u") && u.id !== "u0");
  const total = units.length;
  const completed = units.reduce((acc,u)=>acc + (done[u.id] ? 1 : 0), 0);
  return { total, completed };
}

function updateProgressUI() {
  const { total, completed } = getProgress();
  document.getElementById("progressText").textContent = `${completed}/${total} ƒë√£ ho√†n th√†nh`;
}

function setActiveUnit(unit) {
  activeUnitId = unit.id;
  document.getElementById("activeUnitTitle").textContent = unit.title;
  document.getElementById("activeUnitTopics").textContent = unit.topics || "‚Äî";
  saveState({ activeUnitId });

  // set default prompt hint for writing
  const p = document.getElementById("writingPrompt");
  if (!p.value.trim()) {
    p.placeholder = `D√°n ƒë·ªÅ IELTS v√†o ƒë√¢y... (G·ª£i √Ω: d√πng vocab theo ch·ªß ƒë·ªÅ: ${unit.topics || unit.title})`;
  }
}

function buildUnitList() {
  const st = loadState();
  const units = unitsFromState();
  const done = st.doneUnits || {};
  const q = (document.getElementById("unitSearch").value || "").toLowerCase().trim();

  const list = document.getElementById("unitList");
  list.innerHTML = "";

  units
    .filter(u => {
      if (!q) return true;
      return (u.title + " " + (u.topics||"")).toLowerCase().includes(q);
    })
    .forEach(u => {
      const isDone = !!done[u.id];
      const isActive = (st.activeUnitId || activeUnitId) === u.id;

      const card = document.createElement("div");
      card.className = `p-3 rounded-xl border ${isActive ? "bg-slate-900 text-white border-slate-900" : "bg-white hover:bg-slate-50"} transition`;

      const top = document.createElement("div");
      top.className = "flex items-start gap-2";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = isDone;
      cb.className = "mt-1";
      cb.addEventListener("click", (e) => {
        e.stopPropagation();
        const st2 = loadState();
        const d = st2.doneUnits || {};
        d[u.id] = cb.checked;
        saveState({ doneUnits: d });
        updateProgressUI();
      });

      const title = document.createElement("div");
      title.className = "flex-1";
      title.innerHTML = `
        <div class="text-sm font-semibold leading-snug">${u.title}</div>
        <div class="text-xs ${isActive ? "text-white/80" : "text-slate-500"} leading-snug">${u.topics || ""}</div>
        <div class="text-[11px] ${isActive ? "text-white/70" : "text-slate-400"} mt-1">
          ${u.pdfPage ? `PDF page: ${u.pdfPage}` : "Ch∆∞a map trang (b·∫•m ‚ÄúS·ª≠a map trang‚Äù)"} 
        </div>
      `;

      top.appendChild(cb);
      top.appendChild(title);
      card.appendChild(top);

      card.addEventListener("click", async () => {
        setActiveUnit(u);
        buildUnitList();

        // Jump to mapped page if possible
        if (pdfDoc && u.pdfPage && u.pdfPage > 0) {
          const target = clamp(u.pdfPage, 1, pdfDoc.numPages);
          await renderPage(target);
        }
      });

      list.appendChild(card);
    });

  updateProgressUI();
}

/* =========================
   TOC editor
========================= */
function tocToText(units) {
  return units.map(u => `${u.id}|${u.pdfPage || 0}`).join("\n");
}
function applyTocText(txt) {
  const units = unitsFromState().map(u => ({...u}));
  const lines = txt.split("\n").map(s => s.trim()).filter(Boolean);
  const map = {};
  for (const line of lines) {
    const [id, pageStr] = line.split("|").map(s => (s||"").trim());
    if (!id) continue;
    const p = parseInt(pageStr || "0", 10);
    map[id] = Number.isFinite(p) ? p : 0;
  }
  for (const u of units) {
    if (map.hasOwnProperty(u.id)) u.pdfPage = map[u.id];
  }
  saveState({ units });
  buildUnitList();
}

/* =========================
   Writing corrector via OpenAI Responses API
========================= */
let apiMode = "client"; // "client" | "proxy"
function setMode(mode) {
  apiMode = mode;
  saveState({ apiMode });

  const hint = document.getElementById("modeHint");
  if (mode === "client") {
    hint.textContent = "Client mode: tr√¨nh duy·ªát g·ªçi th·∫≥ng OpenAI. Nhanh nh∆∞ng d·ªÖ l·ªô key (kh√¥ng khuy·∫øn ngh·ªã).";
  } else {
    hint.textContent = "Proxy mode: tr√¨nh duy·ªát g·ªçi t·ªõi server c·ªßa b·∫°n (Vercel/Cloudflare/Node) ƒë·ªÉ che key. Khuy·∫øn ngh·ªã.";
  }
}

function buildWritingPrompt() {
  const unit = unitsFromState().find(u => u.id === (loadState().activeUnitId || activeUnitId)) || null;
  const unitHint = unit ? `∆Øu ti√™n d√πng vocabulary/collocations theo ch·ªß ƒë·ªÅ: ${unit.topics || unit.title}.` : "";

  const taskType = document.getElementById("taskType").value;
  const userPrompt = document.getElementById("writingPrompt").value.trim();
  const draft = document.getElementById("writingDraft").value.trim();

  return `
B·∫°n l√† gi√°m kh·∫£o IELTS Writing v√† gi√°o vi√™n s·ª≠a b√†i.
Nhi·ªám v·ª•: ch·∫•m v√† s·ª≠a b√†i vi·∫øt c·ªßa t√¥i theo ti√™u ch√≠ IELTS (Task Achievement/Response, Coherence & Cohesion, Lexical Resource, Grammar Range & Accuracy).
${unitHint}

H√£y tr·∫£ l·ªùi theo c·∫•u tr√∫c:
1) Band estimate (0.5 step) + 4 ti√™u ch√≠ (g·∫°ch ƒë·∫ßu d√≤ng ng·∫Øn)
2) Nh·ªØng l·ªói ch√≠nh (chia theo: Task, Coherence, Vocabulary, Grammar)
3) S·ª≠a l·ªói tr·ª±c ti·∫øp: li·ªát k√™ 10‚Äì20 l·ªói ti√™u bi·ªÉu d·∫°ng "Sai ‚Üí ƒê√∫ng + gi·∫£i th√≠ch ng·∫Øn"
4) Vi·∫øt l·∫°i b√†i t·ªët h∆°n (gi·ªØ √Ω c·ªßa t√¥i, t·ª± nhi√™n, h·ªçc thu·∫≠t v·ª´a ph·∫£i)
5) 10 t·ª´/c·ª•m t·ª´/collocation n√¢ng band ph√π h·ª£p ch·ªß ƒë·ªÅ + v√≠ d·ª• c√¢u
6) 3 g·ª£i √Ω ƒë·ªÉ t√¥i t·ª± c·∫£i thi·ªán l·∫ßn sau

Lo·∫°i b√†i: ${taskType}

ƒê·ªÅ b√†i:
${userPrompt || "(Ch∆∞a cung c·∫•p ƒë·ªÅ)"}

B√†i t√¥i vi·∫øt:
${draft || "(Ch∆∞a c√≥ b√†i vi·∫øt)"}
`.trim();
}

async function callOpenAI(message) {
  const resultBox = document.getElementById("resultBox");
  resultBox.textContent = "‚è≥ ƒêang ch·∫•m/s·ª≠a...";

  const model = "gpt-4.1-mini"; // fast + good for instruction following :contentReference[oaicite:3]{index=3}

  if (apiMode === "proxy") {
    const url = document.getElementById("proxyUrl").value.trim();
    if (!url) throw new Error("B·∫°n ƒëang ·ªü Proxy mode nh∆∞ng ch∆∞a nh·∫≠p Proxy URL.");

    // Proxy expected to accept: { model, input }
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model,
        input: [{ role: "user", content: [{ type:"input_text", text: message }] }]
      })
    });
    if (!resp.ok) {
      const t = await resp.text();
      throw new Error("Proxy error: " + t);
    }
    const data = await resp.json();
    // Proxy should return OpenAI response JSON (or {output_text})
    return data.output_text || (data.output && data.output[0] && data.output[0].content && data.output[0].content[0] && data.output[0].content[0].text) || JSON.stringify(data, null, 2);
  }

  // Client mode (direct)
  const apiKey = document.getElementById("apiKey").value.trim();
  if (!apiKey) throw new Error("Ch∆∞a nh·∫≠p API key.");

  // Responses API: POST /v1/responses :contentReference[oaicite:4]{index=4}
  const resp = await fetch("https://api.openai.com/v1/responses", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + apiKey
    },
    body: JSON.stringify({
      model,
      input: [{
        role: "user",
        content: [{ type: "input_text", text: message }]
      }]
    })
  });

  const data = await resp.json();
  if (!resp.ok) {
    throw new Error((data && data.error && data.error.message) ? data.error.message : "API error");
  }

  // Many SDKs provide output_text; raw response contains output items :contentReference[oaicite:5]{index=5}
  return data.output_text || extractOutputText(data) || JSON.stringify(data, null, 2);
}

function extractOutputText(data) {
  try {
    if (!data || !Array.isArray(data.output)) return "";
    let out = "";
    for (const item of data.output) {
      if (item.type === "message" && Array.isArray(item.content)) {
        for (const c of item.content) {
          if (c.type === "output_text" && c.text) out += c.text;
          if (c.type === "text" && c.text) out += c.text;
        }
      }
    }
    return out.trim();
  } catch {
    return "";
  }
}

/* =========================
   Events
========================= */
document.getElementById("pdfFile").addEventListener("change", async (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;

  const buf = await f.arrayBuffer();
  await openPdfFromArrayBuffer(buf);
  saveState({ lastPdfName: f.name });

  // if user previously had active unit, jump
  const st = loadState();
  const units = unitsFromState();
  if (st.activeUnitId) {
    const u = units.find(x => x.id === st.activeUnitId);
    if (u) {
      setActiveUnit(u);
      buildUnitList();
      if (u.pdfPage && u.pdfPage > 0) await renderPage(clamp(u.pdfPage, 1, pdfDoc.numPages));
    }
  }
});

document.getElementById("btnPrev").addEventListener("click", async () => {
  if (!pdfDoc) return;
  await renderPage(clamp(currentPage - 1, 1, pdfDoc.numPages));
});
document.getElementById("btnNext").addEventListener("click", async () => {
  if (!pdfDoc) return;
  await renderPage(clamp(currentPage + 1, 1, pdfDoc.numPages));
});
document.getElementById("btnZoomIn").addEventListener("click", async () => {
  if (!pdfDoc) return;
  scale = Math.min(scale + 0.15, 3.0);
  await renderPage(currentPage);
});
document.getElementById("btnZoomOut").addEventListener("click", async () => {
  if (!pdfDoc) return;
  scale = Math.max(scale - 0.15, 0.7);
  await renderPage(currentPage);
});

document.getElementById("btnSave").addEventListener("click", () => {
  saveState({
    quickNotes: document.getElementById("quickNotes").value,
    apiKey: document.getElementById("apiKey").value,
    proxyUrl: document.getElementById("proxyUrl").value,
    taskType: document.getElementById("taskType").value,
    writingPrompt: document.getElementById("writingPrompt").value,
    writingDraft: document.getElementById("writingDraft").value,
  });
  alert("ƒê√£ l∆∞u v√†o tr√¨nh duy·ªát.");
});

document.getElementById("btnReset").addEventListener("click", () => {
  if (confirm("Reset to√†n b·ªô d·ªØ li·ªáu ƒë√£ l∆∞u tr√™n tr√¨nh duy·ªát?")) resetState();
});

document.getElementById("unitSearch").addEventListener("input", buildUnitList);

document.getElementById("btnTOCDefault").addEventListener("click", () => {
  saveState({ units: DEFAULT_UNITS });
  buildUnitList();
  alert("ƒê√£ √°p d·ª•ng m·ª•c l·ª•c m·∫´u. N·∫øu PDF c·ªßa b·∫°n kh√°c trang, b·∫•m ‚ÄúS·ª≠a map trang‚Äù.");
});

document.getElementById("btnTOCEdit").addEventListener("click", () => {
  const box = document.getElementById("tocEditBox");
  box.classList.toggle("hidden");
  document.getElementById("tocEditor").value = tocToText(unitsFromState());
});

document.getElementById("btnApplyTOC").addEventListener("click", () => {
  applyTocText(document.getElementById("tocEditor").value);
  document.getElementById("tocEditBox").classList.add("hidden");
});

document.getElementById("btnCancelTOC").addEventListener("click", () => {
  document.getElementById("tocEditBox").classList.add("hidden");
});

document.getElementById("modeClient").addEventListener("click", () => setMode("client"));
document.getElementById("modeProxy").addEventListener("click", () => setMode("proxy"));

document.getElementById("btnClearWriting").addEventListener("click", () => {
  document.getElementById("writingPrompt").value = "";
  document.getElementById("writingDraft").value = "";
  document.getElementById("resultBox").textContent = "";
  saveState({ writingPrompt:"", writingDraft:"" });
});

document.getElementById("btnCheck").addEventListener("click", async () => {
  try {
    const msg = buildWritingPrompt();
    const output = await callOpenAI(msg);
    document.getElementById("resultBox").textContent = output || "(Kh√¥ng c√≥ output)";
  } catch (err) {
    document.getElementById("resultBox").textContent = "‚ùå " + (err?.message || String(err));
  }
});

/* =========================
   Restore state on load
========================= */
(function init() {
  const st = loadState();

  // restore units
